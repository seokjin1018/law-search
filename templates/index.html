<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>통합 판례 검색</title>
<style>
  body { font-family: sans-serif; }
  h1 { margin-bottom: 20px; }
  .search-wrapper {
    display: flex;
    gap: 20px;
    align-items: flex-start;
  }
  .search-box { flex: 1; }
  .search-box h2 { margin-top: 0; }
  table { border-collapse: collapse; width: 100%; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; vertical-align: top; }
  th { background-color: #f2f2f2; }
  mark { background-color: yellow; font-weight: bold; }
  .page-btn { margin: 4px; padding: 7.5px 15px; cursor: pointer; }
  .page-btn.active { background-color: #007bff; color: white; }

  /* 기존 판례 검색기 전용 스타일 */
  .legacy-table { table-layout: fixed; }
  .legacy-table th.caseinfo, .legacy-table td.caseinfo { width: 16.66%; }
  .legacy-table th.title,    .legacy-table td.title    { width: 16.66%; }
  .legacy-table th.issue,    .legacy-table td.issue    { width: 33.33%; }
  .legacy-table th.reason,   .legacy-table td.reason   { width: 33.33%; }
  .legacy-table td.caseinfo,
  .legacy-table td.title,
  .legacy-table td.issue,
  .legacy-table td.reason {
    white-space: pre-wrap;
    word-break: keep-all;
    line-height: 1.5;
  }
  #legacyPagination { margin-top: 10px; text-align: center; }

  /* 형사 판례 전용 스타일 */
  .criminal-table { table-layout: auto; }
  .criminal-table th.caseinfo, .criminal-table td.caseinfo { width: auto; white-space: nowrap; }
  .criminal-table th.title,    .criminal-table td.title    { width: 25%; }
  .criminal-table th.reason,   .criminal-table td.reason   { width: 20%; }
  .criminal-table th.issue,    .criminal-table td.issue    { width: 35%; }
  .criminal-table td.caseinfo,
  .criminal-table td.title,
  .criminal-table td.issue,
  .criminal-table td.reason {
    white-space: pre-wrap;
    word-break: keep-all;
    line-height: 1.5;
  }
  .criminal-table td.caseinfo a { color: #0066cc; text-decoration: underline; }
  .criminal-table td.caseinfo a:hover { color: #004999; text-decoration: none; }
  #criminalPagination { margin-top: 10px; text-align: center; }

  #criminalSearchContainer .form-row { margin: 6px 0; }
  #criminalSearchContainer select,
  #criminalSearchContainer input[type=text] { padding: 6px; min-width: 240px; }
  #criminalSearchContainer button { padding: 8px 14px; }
  #criminalSearchContainer .label { display:inline-block; min-width:110px; color:#333; }
</style>
</head>
<body>
<h1>통합 판례 검색</h1>
<div class="search-wrapper">

  <!-- 기존 판례 검색기 -->
  <div class="search-box" id="legacySearchContainer">
    <h2>기존 판례검색기</h2>

    <div id="legacyLawList"></div>
    <br>

    <label>검색 모드:
      <select id="legacyMode">
        <option value="SINGLE">단일 키워드</option>
        <option value="AND">AND</option>
        <option value="OR">OR</option>
        <option value="AND_OR">AND (OR)</option>
      </select>
    </label>
    <p id="legacyModeHelp" style="font-size:0.9em; color:#555; margin-top:4px;">
      모드를 선택하면 사용법이 여기에 표시됩니다.
    </p>

    <br><br>
    <label>키워드 (쉼표로 구분): <input type="text" id="legacyKeywords"></label><br><br>
    <label>제외 키워드 (쉼표로 구분): <input type="text" id="legacyExclude"></label><br><br>

    <label>정렬:
      <select id="legacySortBy">
        <option value="default">기본순</option>
        <option value="latest">최신순</option>
        <option value="oldest">오래된 순</option>
      </select>
    </label>
    <br><br>

    <button id="legacySearchBtn">검색</button>
  </div> <!-- 검색기 박스 닫기 -->


  <!-- 형사 판례 검색기 -->
  <div class="search-box" id="criminalSearchContainer">
    <h2>형사 판례검색</h2>

    <div class="form-row">
      <span class="label">검색 모드</span>
      <select id="criminalMode">
        <option value="SINGLE">단일 키워드</option>
        <option value="AND">AND</option>
        <option value="OR">OR</option>
        <option value="AND_OR">AND (OR)</option>
      </select>
    </div>
    <p id="criminalModeHelp" style="font-size:0.9em; color:#555; margin-top:4px;">
      모드를 선택하면 사용법이 여기에 표시됩니다.
    </p>

    <div class="form-row">
      <span class="label">키워드</span>
      <input type="text" id="criminalKeywords" placeholder="쉼표로 구분 (예: 개인정보 보호법, 제15조)">
    </div>

    <div class="form-row">
      <span class="label">제외 키워드</span>
      <input type="text" id="criminalExclude" placeholder="쉼표로 구분">
    </div>

    <div class="form-row">
      <span class="label">법령 선택</span>
      <select id="criminalLawSelect">
        <option value="">법령 선택 (전체)</option>
      </select>
    </div>

    <div class="form-row">
      <span class="label">조문 선택</span>
      <select id="criminalArticleSelect">
        <option value="">조문 선택 (전체)</option>
      </select>
    </div>

    <div class="form-row">
      <span class="label">정렬</span>
      <select id="criminalSortBy">
        <option value="default">기본순</option>
        <option value="latest">최신순</option>
        <option value="oldest">오래된 순</option>
      </select>
    </div>

    <div class="form-row">
      <button id="criminalSearchBtn">검색</button>
    </div>
  </div> <!-- 검색기 박스 닫기 -->

</div> <!-- search-wrapper 닫힘 -->

<!-- 공용 결과 영역 -->
<div id="searchResults" style="margin-top:30px;">
  <h2>검색 결과</h2>
  <div id="loading" style="display:none; color:blue; font-weight:bold;">로딩 중...</div>
  <div id="resultCount" style="margin:5px 0; font-weight:bold;"></div>
  <!-- ✅ 표와 페이지네이션을 같은 영역에 순서대로 -->
  <div id="result"></div>
  <div id="legacyPagination" style="margin-top:10px; text-align:center;"></div>
  <div id="criminalPagination" style="margin-top:10px; text-align:center;"></div>
</div>
<!-- 기존 판례 검색기 JS -->
<script>
let legacyCurrentPage = 1;
const legacyPageSize = 20;
let legacyLastSearchParams = {};

// 기존 판례 검색기 전용 렌더링 함수
function legacyRenderTable(data) {
    const resultEl = document.getElementById("result"); // ✅ 수정: 공용 결과 영역 사용
    if (!data || !data.length) {
        resultEl.innerHTML = "<p>검색 결과가 없습니다.</p>";
        return;
    }

    let html = '<table class="legacy-table"><thead><tr>' +
               '<th class="caseinfo">판례 정보</th>' +
               '<th class="title">제목</th>' +
               '<th class="issue">쟁점</th>' +
               '<th class="reason">선정이유</th>' +
               '</tr></thead><tbody>';

    data.forEach(row => {
        // 판례 정보 + 링크 처리
        let caseInfoVal = row["판례 정보"] || "";
        if (typeof caseInfoVal === "string") {
            const match = caseInfoVal.match(/\b\d{2,4}[가-힣]{1,3}\d+\b/);
            if (match) {
                const caseNo = match[0];
                const link = `https://casenote.kr/대법원/${encodeURIComponent(caseNo)}`;
                caseInfoVal = `<a href="${link}" target="_blank">${caseInfoVal}</a>`;
            }
        }

        html += `<tr>
                   <td class="caseinfo">${caseInfoVal}</td>
                   <td class="title">${row["제목"] || ""}</td>
                   <td class="issue">${row["쟁점"] || ""}</td>
                   <td class="reason">${row["선정이유"] || ""}</td>
                 </tr>`;
    });

    html += "</tbody></table>";
    resultEl.innerHTML = html;
}

function legacyRenderPagination(total) {
    const totalPages = Math.ceil(total / legacyPageSize);
    const container = document.getElementById("legacyPagination");
    if (!container) return;
    container.innerHTML = "";

    if (totalPages <= 1) return;

    const maxVisible = 5;
    let startPage = Math.max(1, legacyCurrentPage - Math.floor(maxVisible / 2));
    let endPage = startPage + maxVisible - 1;

    if (endPage > totalPages) {
        endPage = totalPages;
        startPage = Math.max(1, endPage - maxVisible + 1);
    }

    // « 맨 앞으로
    const firstBtn = document.createElement("button");
    firstBtn.textContent = "«";
    firstBtn.disabled = legacyCurrentPage === 1;
    firstBtn.addEventListener("click", () => legacySearch(1));
    container.appendChild(firstBtn);

    // ‹ 이전
    const prevBtn = document.createElement("button");
    prevBtn.textContent = "‹";
    prevBtn.disabled = legacyCurrentPage === 1;
    prevBtn.addEventListener("click", () => legacySearch(legacyCurrentPage - 1));
    container.appendChild(prevBtn);

    // 페이지 번호
    for (let i = startPage; i <= endPage; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        btn.className = "page-btn" + (i === legacyCurrentPage ? " active" : "");
        btn.addEventListener("click", () => legacySearch(i));
        container.appendChild(btn);
    }

    // › 다음
    const nextBtn = document.createElement("button");
    nextBtn.textContent = "›";
    nextBtn.disabled = legacyCurrentPage === totalPages;
    nextBtn.addEventListener("click", () => legacySearch(legacyCurrentPage + 1));
    container.appendChild(nextBtn);

    // » 맨 뒤로
    const lastBtn = document.createElement("button");
    lastBtn.textContent = "»";
    lastBtn.disabled = legacyCurrentPage === totalPages;
    lastBtn.addEventListener("click", () => legacySearch(totalPages));
    container.appendChild(lastBtn);
}

document.addEventListener("DOMContentLoaded", () => {
    // 법령 목록 불러오기
    fetch("/laws")
        .then(res => res.json())
        .then(laws => {
            const container = document.getElementById("legacyLawList");
            const allLabel = document.createElement("label");
            const allCheckbox = document.createElement("input");
            allCheckbox.type = "checkbox";
            allCheckbox.value = "전체";
            allCheckbox.id = "legacyCheckAll";
            allCheckbox.checked = true;
            allLabel.appendChild(allCheckbox);
            allLabel.appendChild(document.createTextNode(" 전체"));
            container.appendChild(allLabel);
            container.appendChild(document.createElement("br"));
            laws.forEach(law => {
                const label = document.createElement("label");
                const checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.value = law;
                checkbox.checked = true;
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(" " + law));
                container.appendChild(label);
                container.appendChild(document.createElement("br"));
            });
            allCheckbox.addEventListener("change", () => {
                const checkboxes = container.querySelectorAll("input[type=checkbox]");
                checkboxes.forEach(cb => {
                    if (cb !== allCheckbox) cb.checked = allCheckbox.checked;
                });
            });
        });

    // 모드 도움말 표시
    document.getElementById("legacyMode").addEventListener("change", () => {
        const mode = document.getElementById("legacyMode").value;
        const help = document.getElementById("legacyModeHelp");
        if (mode === "AND_OR") {
            help.innerHTML = `AND_OR 모드: 첫 번째 키워드는 반드시 포함, 두 번째 또는 세 번째 키워드 중 하나라도 포함된 결과를 보여줍니다.<br>예) "민법, 계약, 해지"`;
        } else if (mode === "AND") {
            help.textContent = "AND 모드: 쉼표로 구분된 모든 키워드가 포함된 결과를 보여줍니다.";
        } else if (mode === "OR") {
            help.textContent = "OR 모드: 키워드 중 하나라도 포함된 결과를 보여줍니다.";
        } else if (mode === "SINGLE") {
            help.textContent = "SINGLE 모드: 첫 번째 키워드가 포함된 결과를 보여줍니다.";
        }
    });

    // 키 입력 처리
    document.getElementById("legacyKeywords").addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
            e.preventDefault();
            document.getElementById("legacyExclude").focus();
        }
    });

    document.getElementById("legacyExclude").addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
            e.preventDefault();
            legacySearch(1);
        }
    });

    // 검색 버튼 클릭
    document.getElementById("legacySearchBtn").addEventListener("click", () => legacySearch(1));

    // 정렬 변경 시 자동 재검색
    const sortSelect = document.getElementById("legacySortBy");
    if (sortSelect) {
        sortSelect.addEventListener("change", () => legacySearch(1));
    }
});

function legacySearch(page = 1) {
    legacyCurrentPage = page;
    const mode = document.getElementById("legacyMode").value;
    const keywords = document.getElementById("legacyKeywords").value.split(",").map(k => k.trim()).filter(k => k);
    const exclude = document.getElementById("legacyExclude").value.split(",").map(k => k.trim()).filter(k => k);
    const selectedLaws = Array.from(document.querySelectorAll("#legacyLawList input[type=checkbox]:checked")).map(cb => cb.value);
    const sortBy = document.getElementById("legacySortBy") ? document.getElementById("legacySortBy").value : "default";

    legacyLastSearchParams = { mode, keywords, exclude, laws: selectedLaws, sortBy };

    document.getElementById("loading").style.display = "block";
    document.getElementById("resultCount").textContent = "";
    document.getElementById("result").innerHTML = ""; // ✅ 수정: 공용 결과 영역 초기화

    fetch("/search", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ...legacyLastSearchParams, page: legacyCurrentPage, pageSize: legacyPageSize })
    })
    .then(res => res.json())
    .then(data => {
        document.getElementById("loading").style.display = "none";
        document.getElementById("resultCount").textContent = `총 ${data.total}건`;
        legacyRenderTable(data.results);
        legacyRenderPagination(data.total); // ✅ 페이지네이션 호출
    });
}

function legacyFormatIssueText(text) {
    return text
        .replace(/\[([2-9]|\d{2,})\]/g, '\n[$1]')
        .replace(/([②-⑳])/g, '\n$1')
        .replace(/(\d+\.)/g, '\n$1');
}
</script>
<!-- 형사 판례 검색기 JS -->
<script>
let criminalCurrentPage = 1;
const criminalPageSize = 20;
let criminalLastSearchParams = {};

// 형사 판례 검색기 전용 렌더링 함수
function criminalRenderTable(data) {
    const resultEl = document.getElementById("result"); // ✅ 수정: 공용 결과 영역 사용
    if (!data || !data.length) {
        resultEl.innerHTML = "<p>검색 결과가 없습니다.</p>";
        return;
    }

    let html = '<table class="criminal-table"><thead><tr>' +
               '<th class="caseinfo">사건번호 / 선고일</th>' +
               '<th class="title">제목</th>' +
               '<th class="issue">판시사항</th>' +
               '<th class="reason">참조조문</th>' +
               '</tr></thead><tbody>';

    data.forEach(row => {
        // 사건번호
        let caseNoVal = row["사건번호"] || row["사건 정보"] || row["사건정보"] || "";
        if (caseNoVal) {
            const link = `https://casenote.kr/대법원/${encodeURIComponent(caseNoVal)}`;
            caseNoVal = `<a href="${link}" target="_blank">${caseNoVal}</a>`;
        }

        // 선고일
        let dateVal = row["선고일"] || row["선고일자"] || row["판결선고일"] ||
                      row["date"] || row["judgmentDate"] || "";

        html += `<tr>
                   <td class="caseinfo">${caseNoVal}${dateVal ? " / " + dateVal : ""}</td>
                   <td class="title">${row["제목"] || ""}</td>
                   <td class="issue">${criminalFormatIssueText(row["판시사항"] || "")}</td>
                   <td class="reason">${criminalFormatReferenceArticles(row["참조조문"] || "")}</td>
                 </tr>`;
    });

    html += "</tbody></table>";
    resultEl.innerHTML = html;
}

function criminalRenderPagination(total) {
    const totalPages = Math.ceil(total / criminalPageSize);
    const container = document.getElementById("criminalPagination");
    if (!container) return;
    container.innerHTML = "";

    if (totalPages <= 1) return;

    const maxVisible = 5;
    let startPage = Math.max(1, criminalCurrentPage - Math.floor(maxVisible / 2));
    let endPage = startPage + maxVisible - 1;

    if (endPage > totalPages) {
        endPage = totalPages;
        startPage = Math.max(1, endPage - maxVisible + 1);
    }

    // « 맨 앞으로
    const firstBtn = document.createElement("button");
    firstBtn.textContent = "«";
    firstBtn.disabled = criminalCurrentPage === 1;
    firstBtn.addEventListener("click", () => criminalSearch(1));
    container.appendChild(firstBtn);

    // ‹ 이전
    const prevBtn = document.createElement("button");
    prevBtn.textContent = "‹";
    prevBtn.disabled = criminalCurrentPage === 1;
    prevBtn.addEventListener("click", () => criminalSearch(criminalCurrentPage - 1));
    container.appendChild(prevBtn);

    // 페이지 번호
    for (let i = startPage; i <= endPage; i++) {
        const btn = document.createElement("button");
        btn.textContent = i;
        btn.className = "page-btn" + (i === criminalCurrentPage ? " active" : "");
        btn.addEventListener("click", () => criminalSearch(i));
        container.appendChild(btn);
    }

    // › 다음
    const nextBtn = document.createElement("button");
    nextBtn.textContent = "›";
    nextBtn.disabled = criminalCurrentPage === totalPages;
    nextBtn.addEventListener("click", () => criminalSearch(criminalCurrentPage + 1));
    container.appendChild(nextBtn);

    // » 맨 뒤로
    const lastBtn = document.createElement("button");
    lastBtn.textContent = "»";
    lastBtn.disabled = criminalCurrentPage === totalPages;
    lastBtn.addEventListener("click", () => criminalSearch(totalPages));
    container.appendChild(lastBtn);
}
document.addEventListener("DOMContentLoaded", () => {
    criminalInitLawAndArticleDropdowns();

    document.getElementById("criminalMode").addEventListener("change", () => {
        const mode = document.getElementById("criminalMode").value;
        const help = document.getElementById("criminalModeHelp");
        if (mode === "AND_OR") {
            help.innerHTML = `AND_OR 모드: 첫 번째 키워드는 반드시 포함, 두 번째 또는 세 번째 키워드 중 하나라도 포함된 결과를 보여줍니다.<br>예) "민법, 계약, 해지"`;
        } else if (mode === "AND") {
            help.textContent = "AND 모드: 쉼표로 구분된 모든 키워드가 포함된 결과를 보여줍니다.";
        } else if (mode === "OR") {
            help.textContent = "OR 모드: 키워드 중 하나라도 포함된 결과를 보여줍니다.";
        } else if (mode === "SINGLE") {
            help.textContent = "SINGLE 모드: 첫 번째 키워드가 포함된 결과를 보여줍니다.";
        }
    });

    document.getElementById("criminalKeywords").addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
            e.preventDefault();
            document.getElementById("criminalExclude").focus();
        }
    });

    document.getElementById("criminalExclude").addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
            e.preventDefault();
            criminalSearch(1);
        }
    });

    document.getElementById("criminalSearchBtn").addEventListener("click", () => criminalSearch(1));

    const sortSelect = document.getElementById("criminalSortBy");
    if (sortSelect) {
        sortSelect.addEventListener("change", () => criminalSearch(1));
    }
});

async function criminalInitLawAndArticleDropdowns() {
    const lawSelect = document.getElementById("criminalLawSelect");
    const articleSelect = document.getElementById("criminalArticleSelect");

    const laws = await fetch("/criminal/laws").then(res => res.json()).catch(() => []);
    lawSelect.innerHTML = `<option value="">법령 선택 (전체)</option>` +
        laws.map(l => `<option value="${criminalEscapeHtml(l)}">${criminalEscapeHtml(l)}</option>`).join("");

    lawSelect.addEventListener("change", async () => {
        const law = lawSelect.value;
        articleSelect.innerHTML = `<option value="">조문 선택 (전체)</option>`;
        if (!law) return;
        const items = await fetch(`/criminal/articles?law=${encodeURIComponent(law)}`)
            .then(res => res.json()).catch(() => []);
        articleSelect.innerHTML = `<option value="">조문 선택 (전체)</option>` +
            items.map(a => `<option value="${criminalEscapeHtml(a)}">${criminalEscapeHtml(a)}</option>`).join("");
    });
}

function criminalEscapeHtml(s) {
    return (s || "").replace(/[&<>"']/g, ch => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[ch]));
}

function criminalSearch(page = 1) {
    criminalCurrentPage = page;
    const mode = document.getElementById("criminalMode").value;
    const keywords = document.getElementById("criminalKeywords").value.split(",").map(k => k.trim()).filter(k => k);
    const exclude = document.getElementById("criminalExclude").value.split(",").map(k => k.trim()).filter(k => k);
    const selectedLaw = document.getElementById("criminalLawSelect").value || "";
    const selectedArticle = document.getElementById("criminalArticleSelect").value || "";
    const sortBy = document.getElementById("criminalSortBy") ? document.getElementById("criminalSortBy").value : "default";

    criminalLastSearchParams = { mode, keywords, exclude, selectedLaw, selectedArticle, sortBy };

    document.getElementById("loading").style.display = "block";
    document.getElementById("resultCount").textContent = "";
    document.getElementById("result").innerHTML = ""; // ✅ 수정: 공용 결과 영역 초기화

    fetch("/criminal/search", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ...criminalLastSearchParams, page: criminalCurrentPage, pageSize: criminalPageSize })
    })
    .then(res => res.json())
    .then(data => {
        document.getElementById("loading").style.display = "none";
        document.getElementById("resultCount").textContent = `총 ${data.total}건`;
        criminalRenderTable(data.results);
        criminalRenderPagination(data.total); // ✅ 페이지네이션 호출
    });
}

function criminalHighlightText(text, keywords) {
    if (!text || !keywords.length) return text;
    let result = text;
    keywords.forEach(kw => {
        if (!kw) return;
        const pattern = new RegExp("(" + kw.split("").join("\\s*") + ")", "gi");
        result = result.replace(pattern, "<mark>$1</mark>");
    });
    return result;
}

// 참조조문 그룹핑
function criminalFormatReferenceArticles(text) {
    if (!text) return "";
    const parts = text.split(",").map(p => p.trim()).filter(Boolean);
    const grouped = {};
    parts.forEach(p => {
        const match = p.match(/^(.*?)\s*(제\d+조.*)$/);
        if (match) {
            const law = match[1].trim();
            const article = match[2].trim();
            if (!grouped[law]) grouped[law] = [];
            grouped[law].push(article);
        } else {
            if (!grouped[""]) grouped[""] = [];
            grouped[""].push(p);
        }
    });
    const result = [];
    for (const [law, articles] of Object.entries(grouped)) {
        if (!law) {
            result.push(...articles);
        } else {
            const first = `${law} ${articles[0]}`;
            const rest = articles.slice(1).map(a => `${a}`);
            result.push([first, ...rest].join(", "));
        }
    }
    return result.join(", ");
}

function criminalFormatIssueText(text) {
    return (text || "")
        .replace(/\[([2-9]|\d{2,})\]/g, '\n[$1]')
        .replace(/([②-⑳])/g, '\n$1')
        .replace(/(\d+\.)/g, '\n$1');
}
</script>
</body>
</html>